<template>
    <div class="relative w-full overflow-hidden rounded-xl">
        <img src="/images/hero/main.jpg" alt="" class="w-full h-full object-cover object-center max-md:aspect-[7/11]">
        <div class="absolute inset-0 bg-black/30"></div>
        <div class="absolute inset-0 py-10 px-4 flex justify-center items-center text-center text-white">
            <div class="flex flex-col items-center relative gap-6 w-fit p-4 lg:p-6 max-w-2xl">
                <div class="absolute inset-0 backdrop-blur-md rounded-xl"></div>
                <p class="text-4xl font-mono font-semibold z-[1]">–ö–Ω–∏–≥–∏. –ö–æ—Ñ–µ. –í–¥–æ—Ö–Ω–æ–≤–µ–Ω–∏–µ.</p>
                <p class="opacity-70 text-lg tracking-wide z-[1]">
                    –£—é—Ç–Ω–æ–µ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ, –≥–¥–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –æ–∂–∏–≤–∞—é—Ç –≤–º–µ—Å—Ç–µ —Å –∞—Ä–æ–º–∞—Ç–æ–º —Å–≤–µ–∂–µ–≥–æ –∫–æ—Ñ–µ.
                    –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –ø—Ä–æ–≤–µ—Å—Ç–∏ –≤—Ä–µ–º—è –∑–∞ –ª—é–±–∏–º–æ–π –∫–Ω–∏–≥–æ–π, –æ—Ç–∫—Ä—ã—Ç—å –¥–ª—è —Å–µ–±—è –Ω–æ–≤—ã–µ –∏—Å—Ç–æ—Ä–∏–∏.
                </p>
            </div>
        </div>
    </div>
    <div class="flex flex-col gap-6">
        <p class="mainHeading">–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å–∏—Å—Ç–µ–º–∞ –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏</p>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div class="p-4 rounded-xl bg-blue-50 border border-blue-200">
                <h3 class="text-lg font-semibold text-blue-800 mb-2">üí∞ –°—É–º–º–∞ –ø–æ–∫—É–ø–æ–∫ (P1)</h3>
                <p class="text-sm text-blue-700 mb-2">–í–µ—Å: 50%</p>
                <p class="text-sm text-gray-600">–û–±—â–∞—è —Å—É–º–º–∞ –≤—Å–µ—Ö –ø–æ–∫—É–ø–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π —Å—É–º–º—ã —Å—Ä–µ–¥–∏ –≤—Å–µ—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤</p>
            </div>
            <div class="p-4 rounded-xl bg-green-50 border border-green-200">
                <h3 class="text-lg font-semibold text-green-800 mb-2">üìÖ –ß–∞—Å—Ç–æ—Ç–∞ –ø–æ–∫—É–ø–æ–∫ (P2)</h3>
                <p class="text-sm text-green-700 mb-2">–í–µ—Å: 30%</p>
                <p class="text-sm text-gray-600">–°—Ä–µ–¥–Ω–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–∫–∞–∑–æ–≤ –≤ –º–µ—Å—è—Ü. –ó–∞–∫–∞–∑—ã –≥—Ä—É–ø–ø–∏—Ä—É—é—Ç—Å—è –ø–æ –º–∏–Ω—É—Ç–∞–º –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è. –§–æ—Ä–º—É–ª–∞: –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ_–∑–∞–∫–∞–∑–æ–≤ √∑ –º–µ—Å—è—Ü—ã_—Å_–ø–µ—Ä–≤–æ–π_–ø–æ–∫—É–ø–∫–∏</p>
            </div>
            <div class="p-4 rounded-xl bg-purple-50 border border-purple-200">
                <h3 class="text-lg font-semibold text-purple-800 mb-2">‚è∞ –°–≤–µ–∂–µ—Å—Ç—å –∫–ª–∏–µ–Ω—Ç–∞ (P3)</h3>
                <p class="text-sm text-purple-700 mb-2">–í–µ—Å: 20%</p>
                <p class="text-sm text-gray-600">–í—Ä–µ–º—è —Å –ø–æ—Å–ª–µ–¥–Ω–µ–π –ø–æ–∫—É–ø–∫–∏ –≤ –¥–Ω—è—Ö. –ß–µ–º –º–µ–Ω—å—à–µ –¥–Ω–µ–π, —Ç–µ–º –ª—É—á—à–µ. –§–æ—Ä–º—É–ª–∞: 1 - (–¥–Ω–∏_—Å_–ø–æ—Å–ª–µ–¥–Ω–µ–π_–ø–æ–∫—É–ø–∫–∏ √∑ –º–∞–∫—Å–∏–º—É–º_—Å—Ä–µ–¥–∏_–≤—Å–µ—Ö)</p>
            </div>
        </div>
        <div class="p-4 rounded-xl bg-yellow-50 border border-yellow-200">
            <h3 class="text-lg font-semibold text-yellow-800 mb-2">üéØ –ò–Ω—Ç–µ–≥—Ä–∞–ª—å–Ω—ã–π –ø–æ–∫–∞–∑–∞—Ç–µ–ª—å –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏ (–ò–ü–õ)</h3>
            <p class="text-sm text-gray-600 mb-2">–ò–ü–õ = (0.5 √ó P1) + (0.3 √ó P2) + (0.2 √ó P3)</p>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
                <div><strong>–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π:</strong> –ò–ü–õ < 0.3 ‚Üí —Å–∫–∏–¥–∫–∞ 5%</div>
                <div><strong>–°–µ—Ä–µ–±—Ä—è–Ω—ã–π:</strong> 0.3 ‚â§ –ò–ü–õ < 0.6 ‚Üí —Å–∫–∏–¥–∫–∞ 10%</div>
                <div><strong>–ó–æ–ª–æ—Ç–æ–π:</strong> –ò–ü–õ ‚â• 0.6 ‚Üí —Å–∫–∏–¥–∫–∞ 15%</div>
            </div>
        </div>
    </div>
    <div class="flex flex-col gap-6">
        <p class="mainHeading">–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞—Å—á—ë—Ç–æ–≤ —Å–∏—Å—Ç–µ–º—ã –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏</p>
        <div class="p-4 rounded-xl bg-gray-50 border border-gray-200">
            <div class="flex flex-col md:flex-row gap-4 items-start md:items-center mb-4">
                <label class="text-sm font-semibold text-gray-700">ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:</label>
                <input 
                    v-model="checkUserId" 
                    @input="loadUserCalculation"
                    type="number" 
                    placeholder="–í–≤–µ–¥–∏—Ç–µ ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"
                    class="px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-sky-500 w-full md:w-48"
                >
                <button 
                    @click="loadUserCalculation"
                    :disabled="isLoadingCalculation"
                    class="px-4 py-2 bg-sky-500 text-white rounded-lg hover:bg-sky-600 disabled:opacity-50 transition-colors"
                >
                    {{ isLoadingCalculation ? '–ó–∞–≥—Ä—É–∑–∫–∞...' : '–†–∞—Å—Å—á–∏—Ç–∞—Ç—å' }}
                </button>
            </div>
            
            <div v-if="userCalculation" class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <!-- –ë–∞–∑–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ -->
                    <div class="p-3 rounded-lg bg-white border">
                        <h4 class="font-semibold text-gray-800 mb-2">üìä –ë–∞–∑–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ</h4>
                        <div class="space-y-1 text-sm">
                            <div><span class="font-medium">ID:</span> {{ userCalculation.user_id }}</div>
                            <div><span class="font-medium">–ò–º—è:</span> {{ userCalculation.name }}</div>
                            <div><span class="font-medium">–ó–∞–∫–∞–∑–æ–≤:</span> {{ userCalculation.orders_count }}</div>
                            <div><span class="font-medium">–°—É–º–º–∞ –ø–æ–∫—É–ø–æ–∫:</span> {{ userCalculation.total_spent.toLocaleString() }} ‚ÇΩ</div>
                            <div><span class="font-medium">–ú–µ—Å—è—Ü–µ–≤ —Å –ø–µ—Ä–≤–æ–π –ø–æ–∫—É–ø–∫–∏:</span> {{ userCalculation.months_between }}</div>
                            <div><span class="font-medium">–ó–∞–∫–∞–∑–æ–≤ –≤ –º–µ—Å—è—Ü:</span> {{ userCalculation.avg_purchases_per_month }}</div>
                            <div><span class="font-medium">–î–Ω–µ–π —Å –ø–æ—Å–ª–µ–¥–Ω–µ–π –ø–æ–∫—É–ø–∫–∏:</span> {{ userCalculation.days_since_last_order }}</div>
                        </div>
                    </div>

                    <!-- –ú–∞–∫—Å–∏–º—É–º—ã –¥–ª—è –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏ -->
                    <div class="p-3 rounded-lg bg-white border">
                        <h4 class="font-semibold text-gray-800 mb-2">üìà –ú–∞–∫—Å–∏–º—É–º—ã —Å—Ä–µ–¥–∏ –≤—Å–µ—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤</h4>
                        <div class="space-y-1 text-sm">
                            <div><span class="font-medium">–ú–∞–∫—Å. —Å—É–º–º–∞:</span> {{ userCalculation.max_total_spent.toLocaleString() }} ‚ÇΩ</div>
                            <div><span class="font-medium">–ú–∞–∫—Å. —á–∞—Å—Ç–æ—Ç–∞:</span> {{ userCalculation.max_avg_per_month }}</div>
                            <div><span class="font-medium">–ú–∞–∫—Å. –¥–Ω–µ–π –±–µ–∑ –ø–æ–∫—É–ø–∫–∏:</span> {{ userCalculation.max_days_since_last }}</div>
                        </div>
                    </div>

                    <!-- –ù–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã -->
                    <div class="p-3 rounded-lg bg-white border">
                        <h4 class="font-semibold text-gray-800 mb-2">üéØ –ù–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã</h4>
                        <div class="space-y-1 text-sm">
                            <div><span class="font-medium">P1 (—Å—É–º–º–∞):</span> {{ userCalculation.p1_norm }}</div>
                            <div><span class="font-medium">P2 (—á–∞—Å—Ç–æ—Ç–∞):</span> {{ userCalculation.p2_norm }}</div>
                            <div><span class="font-medium">P3 (—Å–≤–µ–∂–µ—Å—Ç—å):</span> {{ userCalculation.p3_norm }}</div>
                        </div>
                    </div>
                </div>

                <!-- –ò—Ç–æ–≥–æ–≤—ã–π —Ä–∞—Å—á—ë—Ç -->
                <div class="p-4 rounded-lg bg-yellow-50 border border-yellow-200">
                    <h4 class="font-semibold text-yellow-800 mb-2">üßÆ –ò—Ç–æ–≥–æ–≤—ã–π —Ä–∞—Å—á—ë—Ç –ò–ü–õ</h4>
                    <div class="text-sm space-y-1">
                        <div><span class="font-medium">–§–æ—Ä–º—É–ª–∞:</span> K = (0.5 √ó P1) + (0.3 √ó P2) + (0.2 √ó P3)</div>
                        <div><span class="font-medium">–†–∞—Å—á—ë—Ç:</span> K = (0.5 √ó {{ userCalculation.p1_norm }}) + (0.3 √ó {{ userCalculation.p2_norm }}) + (0.2 √ó {{ userCalculation.p3_norm }})</div>
                        <div><span class="font-medium">–ò–ü–õ (K):</span> <span class="font-bold text-lg">{{ userCalculation.k }}</span></div>
                        <div><span class="font-medium">–£—Ä–æ–≤–µ–Ω—å:</span> <span class="font-bold text-lg" :class="getLevelColor(userCalculation.client_level)">{{ userCalculation.client_level }}</span></div>
                        <div><span class="font-medium">–°–∫–∏–¥–∫–∞:</span> <span class="font-bold text-lg text-green-600">{{ userCalculation.discount_percent }}%</span></div>
                    </div>
                </div>
            </div>

            <div v-else-if="!isLoadingCalculation && checkUserId" class="text-center text-gray-500 py-4">
                –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å ID {{ checkUserId }} –Ω–µ –Ω–∞–π–¥–µ–Ω –∏–ª–∏ —É –Ω–µ–≥–æ –Ω–µ—Ç –∑–∞–∫–∞–∑–æ–≤
            </div>
        </div>
    </div>
    <div class="flex flex-col gap-6">
        <p class="mainHeading">–ü—Ä–∏—á–∏–Ω—ã –≤—ã–±—Ä–∞—Ç—å Book Caf√©</p>
        <p>–ó–¥–µ—Å—å –≤—Ä–µ–º—è —Ç–µ—á–µ—Ç –∏–Ω–∞—á–µ: –º–∏–Ω—É—Ç—ã –∑–∞ –∫–Ω–∏–≥–æ–π –∫–∞–∂—É—Ç—Å—è —á–∞—Å–∞–º–∏, –∞ —á–∞—Å—ã –∑–∞ –∫–æ—Ñ–µ ‚Äî –º–≥–Ω–æ–≤–µ–Ω–∏—è–º–∏</p>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
            <div
                class="flex flex-col gap-4 p-4 rounded-xl bg-white border border-gray-300 shadow-md transition-all duration-500 hover:-translate-y-2">
                <p class="text-2xl font-mono font-semibold text-[#131313]/80">–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ üìö</p>
                <p>–£—é—Ç–Ω—ã–µ –∑–∞–ª—ã —Å –¥–∏–≤–∞–Ω–∞–º–∏ –∏ –ø–æ–ª–∫–∞–º–∏ –∫–Ω–∏–≥, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–∂–Ω–æ —á–∏—Ç–∞—Ç—å –±–µ—Å–ø–ª–∞—Ç–Ω–æ.</p>
            </div>
            <div
                class="flex flex-col gap-4 p-4 rounded-xl bg-white border border-gray-300 shadow-md transition-all duration-500 hover:-translate-y-2">
                <p class="text-2xl font-mono font-semibold text-[#131313]/80">–ê–≤—Ç–æ—Ä—Å–∫–∏–π –∫–æ—Ñ–µ ‚òïÔ∏è</p>
                <p>–≠–∫—Å–∫–ª—é–∑–∏–≤–Ω—ã–µ —Å–º–µ—Å–∏ –æ—Ç –º–µ—Å—Ç–Ω—ã—Ö –æ–±–∂–∞—Ä—â–∏–∫–æ–≤ –∏ —Å–µ–∑–æ–Ω–Ω—ã–µ –Ω–∞–ø–∏—Ç–∫–∏ —Å –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä–Ω—ã–º–∏ –Ω–∞–∑–≤–∞–Ω–∏—è–º–∏.</p>
            </div>
            <div
                class="flex flex-col gap-4 p-4 rounded-xl bg-white border border-gray-300 shadow-md transition-all duration-500 hover:-translate-y-2">
                <p class="text-2xl font-mono font-semibold text-[#131313]/80">–ò–≤–µ–Ω—Ç—ã üìñ</p>
                <p>–ï–∂–µ–Ω–µ–¥–µ–ª—å–Ω—ã–µ —á—Ç–µ–Ω–∏—è, –≤—Å—Ç—Ä–µ—á–∏ —Å –∞–≤—Ç–æ—Ä–∞–º–∏ –∏ —Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –≤–µ—á–µ—Ä–∞.</p>
            </div>
            <div
                class="flex flex-col gap-4 p-4 rounded-xl bg-white border border-gray-300 shadow-md transition-all duration-500 hover:-translate-y-2">
                <p class="text-2xl font-mono font-semibold text-[#131313]/80">–ö–æ–≤–æ—Ä–∫–∏–Ω–≥ üíª</p>
                <p>–¢–∏—Ö–∏–µ —É–≥–æ–ª–∫–∏ —Å —Ä–æ–∑–µ—Ç–∫–∞–º–∏ –∏ –±—ã—Å—Ç—Ä—ã–º Wi-Fi –¥–ª—è –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ–π —Ä–∞–±–æ—Ç—ã.</p>
            </div>
        </div>
    </div>
    <div class="flex flex-col gap-6">
        <p class="mainHeading">–ü—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ, –≥–¥–µ —Ö–æ—á–µ—Ç—Å—è –æ—Å—Ç–∞—Ç—å—Å—è</p>
        <div ref="container" class="flex w-full overflow-hidden group gap-4 lg:h-96 max-lg:flex-col max-lg:h-80">
            <div v-for="(image, index) in images" :key="index" :ref="el => { if (el) items[index] = el }"
                class="w-full lg:w-1/4 transition-all duration-500 lg:group-hover:w-[15%] lg:hover:!w-[50%] max-lg:h-40 rounded-xl overflow-hidden"
                :class="{ '!h-[500px]': activeIndex === index }" @click="handleClick(index)">
                <img :src="image" class="w-full h-full object-cover">
            </div>
        </div>
    </div>
    <div class="flex flex-col gap-6">
        <p class="mainHeading">–ö–æ–º–∞–Ω–¥–∞ Book Caf√©</p>
        <p>–ú—ã –Ω–µ –ø—Ä–æ—Å—Ç–æ –ø–æ–¥–∞—ë–º –∫–æ—Ñ–µ ‚Äî –º—ã —Å–æ–∑–¥–∞—ë–º –º–µ—Å—Ç–æ, –≥–¥–µ —Ä–æ–∂–¥–∞—é—Ç—Å—è –∏–¥–µ–∏, –∞ –∫–Ω–∏–≥–∏ –æ–±—Ä–µ—Ç–∞—é—Ç –Ω–æ–≤—ã—Ö –¥—Ä—É–∑–µ–π</p>
        <div class="flex flex-col gap-6">
            <div class="flex max-md:flex-col items-center gap-6">
                <img src="/images/team/1.jpg" alt="" class="object-cover object-top aspect-square w-full md:w-1/2 rounded-xl">
                <div class="flex flex-col gap-4 w-full md:w-1/2">
                    <p class="text-2xl font-mono font-semibold text-[#131313]/80">–ê–Ω–Ω–∞ ‚Äî –û—Å–Ω–æ–≤–∞—Ç–µ–ª—å –∏ –ì–ª–∞–≤–Ω—ã–π –ë–∞—Ä–∏—Å—Ç–∞</p>
                    <p>10 –ª–µ—Ç –≤ –∫–æ—Ñ–µ–π–Ω–æ–π –∏–Ω–¥—É—Å—Ç—Ä–∏–∏, –∞–≤—Ç–æ—Ä —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö —Ä–µ—Ü–µ–ø—Ç–æ–≤ –∏ —Ü–µ–Ω–∏—Ç–µ–ª—å –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–æ–π –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä—ã.</p>
                    <div class="p-2 border-l-4 border-sky-400 bg-sky-50">
                        <p class="italic font-semibold text-[#131313]/80">
                            "–ö–æ—Ñ–µ ‚Äî —ç—Ç–æ –∏—Å–∫—É—Å—Å—Ç–≤–æ, –∞ –∫–Ω–∏–≥–∏ ‚Äî –≤–¥–æ—Ö–Ω–æ–≤–µ–Ω–∏–µ"
                        </p>
                    </div>
                </div>
            </div>
            <div class="flex max-md:flex-col items-center gap-6">
                <img src="/images/team/2.jpg" alt="" class="object-cover object-top aspect-square w-full md:w-1/2 md:order-last rounded-xl">
                <div class="flex flex-col gap-4 w-full md:w-1/2">
                    <p class="text-2xl font-mono font-semibold text-[#131313]/80">–ú–∞–∫—Å–∏–º ‚Äî –®–µ—Ñ-–ö–æ–Ω–¥–∏—Ç–µ—Ä</p>
                    <p>–°–æ–∑–¥–∞—ë—Ç —Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ —Å–ª–∞–¥–æ—Å—Ç–∏ –ø–æ –º–æ—Ç–∏–≤–∞–º –∫–Ω–∏–≥. –û–±–æ–∂–∞–µ—Ç –ë—É–ª–≥–∞–∫–æ–≤–∞ –∏ –∫—É–ª–∏–Ω–∞—Ä–Ω—ã–µ —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç—ã.</p>
                    <div class="p-2 border-l-4 border-sky-400 bg-sky-50">
                        <p class="italic font-semibold text-[#131313]/80">
                            "–î–µ—Å–µ—Ä—Ç—ã –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —Ç–∞–∫–∏–º–∏ –∂–µ —É–≤–ª–µ–∫–∞—Ç–µ–ª—å–Ω—ã–º–∏, –∫–∞–∫ —Ö–æ—Ä–æ—à–∏–π —Ä–æ–º–∞–Ω"
                        </p>
                    </div>
                </div>
            </div>
            <div class="flex max-md:flex-col items-center gap-6">
                <img src="/images/team/3.jpg" alt="" class="object-cover object-top aspect-square w-full md:w-1/2 rounded-xl">
                <div class="flex flex-col gap-4 w-full md:w-1/2">
                    <p class="text-2xl font-mono font-semibold text-[#131313]/80">–ò–≤–∞–Ω ‚Äî –õ–∏—Ç–µ—Ä–∞—Ç—É—Ä–Ω—ã–π –ö—É—Ä–∞—Ç–æ—Ä</p>
                    <p>–§–∏–ª–æ–ª–æ–≥, –æ—Ä–≥–∞–Ω–∏–∑–∞—Ç–æ—Ä –∫–Ω–∏–∂–Ω—ã—Ö –∫–ª—É–±–æ–≤ –∏ –º–∞—Å—Ç–µ—Ä-–∫–ª–∞—Å—Å–æ–≤. –ó–Ω–∞–µ—Ç –≤—Å—ë –æ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –∞–≤—Ç–æ—Ä–∞—Ö.</p>
                    <div class="p-2 border-l-4 border-sky-400 bg-sky-50">
                        <p class="italic font-semibold text-[#131313]/80">
                            "–ö–∞–∂–¥–∞—è –∫–Ω–∏–≥–∞ –Ω–∞ –Ω–∞—à–µ–π –ø–æ–ª–∫–µ –ø—Ä–æ—Ö–æ–¥–∏—Ç —Å—Ç—Ä–æ–≥–∏–π –æ—Ç–±–æ—Ä"
                        </p>
                    </div>
                </div>
            </div>
            <div class="flex max-md:flex-col items-center gap-6">
                <img src="/images/team/4.jpg" alt="" class="object-cover object-top aspect-square w-full md:w-1/2 md:order-last rounded-xl">
                <div class="flex flex-col gap-4 w-full md:w-1/2">
                    <p class="text-2xl font-mono font-semibold text-[#131313]/80">–ú–∞—Ä–∏—è ‚Äî –ú–µ–Ω–µ–¥–∂–µ—Ä –ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π</p>
                    <p>–û—Ä–≥–∞–Ω–∏–∑—É–µ—Ç –≤—Å—Ç—Ä–µ—á–∏ —Å –ø–∏—Å–∞—Ç–µ–ª—è–º–∏, –ø–æ—ç—Ç–∏—á–µ—Å–∫–∏–µ –≤–µ—á–µ—Ä–∞ –∏ –¥–µ—Ç—Å–∫–∏–µ —á—Ç–µ–Ω–∏—è.</p>
                    <div class="p-2 border-l-4 border-sky-400 bg-sky-50">
                        <p class="italic font-semibold text-[#131313]/80">
                            "–ö–æ—Ñ–µ + –∫–Ω–∏–≥–∏ + –ª—é–¥–∏ = –º–∞–≥–∏—è"
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="flex flex-col gap-6">
        <p class="mainHeading">–ü–æ—Å–ª–µ–¥–Ω–∏–µ –Ω–æ–≤–æ—Å—Ç–∏</p>
        <div v-if="isLoadingNews" class="flex justify-center items-center min-h-[300px]">
            <Loader />
        </div>
        <div v-else class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <NuxtLink v-for="newCard in news" :to="`/news/new-${newCard.id}`" class="flex flex-col gap-6 rounded-xl overflow-hidden shadow-md border border-gray-300 group">
                <img src="/images/news/main.jpg" alt="" class="transition-all duration-500 group-hover:scale-110">
                <div class="flex flex-col gap-4 p-6 grow">
                    <span class="text-2xl font-mono font-semibold text-[#131313]/80">{{ newCard.title }}</span>
                    <span class="line-clamp-3 mt-auto">{{ newCard.description }}</span>
                    <span class="peer py-1.5 px-4 w-fit rounded-lg bg-sky-500 border border-sky-500 text-white transition-all duration-500 group-hover:text-sky-400 group-hover:bg-transparent">–ß–∏—Ç–∞—Ç—å –ù–æ–≤–æ—Å—Ç—å</span>
                </div>
            </NuxtLink>
        </div>
    </div>
</template>

<script setup>
/* –Ω–∞–∑–≤–∞–Ω–∏–µ –∏ —è–∑—ã–∫ —Å—Ç—Ä–∞–Ω–∏—Ü—ã */
useSeoMeta({
    title: '–ì–ª–∞–≤–Ω–∞—è',
    lang: 'ru'
})


/* –ª–æ–≥–∏–∫–∞ –¥–ª—è –±–ª–æ–∫–∞ –≥–∞–ª–µ—Ä–µ–∏ */
const images = [
  '/images/gallery/1.jpeg',
  '/images/gallery/2.jpeg',
  '/images/gallery/3.jpeg',
  '/images/gallery/4.jpeg'
]

const items = ref([])
const activeIndex = ref(null)
const container = ref(null)

const handleClick = (index) => {
  if (window.innerWidth >= 1024) return // –ù–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–ª–∏–∫–∏ –Ω–∞ –¥–µ—Å–∫—Ç–æ–ø–µ
  
  if (activeIndex.value === index) {
    // –ï—Å–ª–∏ –∫–ª–∏–∫–∞–µ–º –Ω–∞ —É–∂–µ –∞–∫—Ç–∏–≤–Ω—ã–π —ç–ª–µ–º–µ–Ω—Ç - –∑–∞–∫—Ä—ã–≤–∞–µ–º
    activeIndex.value = null
  } else {
    // –ò–Ω–∞—á–µ –æ—Ç–∫—Ä—ã–≤–∞–µ–º –Ω–æ–≤—ã–π
    activeIndex.value = index
    
    // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –∫ –∞–∫—Ç–∏–≤–Ω–æ–º—É —ç–ª–µ–º–µ–Ω—Ç—É
    nextTick(() => {
      items.value[index]?.scrollIntoView({
        behavior: 'smooth',
        block: 'nearest'
      })
    })
  }
}

// –ó–∞–∫—Ä—ã–≤–∞–µ–º –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –æ–±–ª–∞—Å—Ç–∏
const onClickOutside = (event) => {
  if (window.innerWidth >= 1024) return
  
  if (container.value && !container.value.contains(event.target)) {
    activeIndex.value = null
  }
}

onMounted(() => {
  window.addEventListener('click', onClickOutside)
})

onBeforeUnmount(() => {
  window.removeEventListener('click', onClickOutside)
})


/* –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –ë–î –∏ –≤—ã–≤–æ–¥ –¥–∞–Ω–Ω—ã—Ö */
const supabase = useSupabaseClient()

const news = ref([])
const isLoadingNews = ref(true)
const checkUserId = ref(1) /* 1 */
const userCalculation = ref(null) /* 2 */
const isLoadingCalculation = ref(false) /* 3 */

const loadNews = async () => {
  try {
    const { data, error } = await supabase
    .from('news')
    .select("*")
    .order('id', {ascending: false})
    .limit(3)
    
    if (error) throw error
    news.value = data || []
  } finally {
    isLoadingNews.value = false
  }
}

onMounted(() => {
  loadNews()
  loadUserCalculation() /* 4 */
})

/* 5 */
const getLevelColor = (level) => {
  switch(level) {
    case '–ó–æ–ª–æ—Ç–æ–π': return 'text-yellow-600'
    case '–°–µ—Ä–µ–±—Ä—è–Ω—ã–π': return 'text-gray-600'
    case '–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π': return 'text-blue-600'
    default: return 'text-gray-600'
  }
}

const loadUserCalculation = async () => {
  if (!checkUserId.value) {
    userCalculation.value = null
    return
  }

  isLoadingCalculation.value = true
  try {
    // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    const { data: user, error: userError } = await supabase
      .from('users')
      .select('id, name, surname, patronymic')
      .eq('id', checkUserId.value)
      .single()

    if (userError || !user) {
      userCalculation.value = null
      return
    }

    // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –æ–ø–ª–∞—á–µ–Ω–Ω—ã–µ –ø–æ–∑–∏—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    const { data: cartRows, error: cartError } = await supabase
      .from('cart')
      .select('id, created_at, count, price, status')
      .eq('userId', checkUserId.value)
      .eq('status', '–û—Ñ–æ—Ä–º–ª–µ–Ω')
      .order('created_at', { ascending: true })

    if (cartError) {
      userCalculation.value = null
      return
    }

    const paidItems = Array.isArray(cartRows) ? cartRows : []
    
    if (paidItems.length === 0) {
      userCalculation.value = null
      return
    }

    // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ –º–∏–Ω—É—Ç–∞–º (–∑–∞–∫–∞–∑—ã)
    const orderGroups = new Map()
    paidItems.forEach(item => {
      const t = new Date(item.created_at)
      const key = new Date(t.getFullYear(), t.getMonth(), t.getDate(), t.getHours(), t.getMinutes()).getTime()
      if (!orderGroups.has(key)) orderGroups.set(key, [])
      orderGroups.get(key).push(item)
    })

    const orders = Array.from(orderGroups.values())
    const ordersCount = orders.length
    const totalSpent = paidItems.reduce((acc, r) => acc + Number(r.price || 0) * Number(r.count || 0), 0)
    const lastOrderAt = orders.length ? orders[orders.length - 1][0].created_at : null
    const firstOrderAt = orders.length ? orders[0][0].created_at : null

    // –†–∞—Å—á—ë—Ç –º–µ—Å—è—Ü–µ–≤
    const monthsBetween = (start, end) => {
      const s = new Date(start)
      const e = new Date(end)
      const years = e.getFullYear() - s.getFullYear()
      const months = e.getMonth() - s.getMonth()
      const total = years * 12 + months + (e.getDate() >= s.getDate() ? 0 : -1)
      return Math.max(1, total)
    }

    const months_between = monthsBetween(firstOrderAt, new Date())
    const avgPurchasesPerMonth = ordersCount === 0 || !firstOrderAt
      ? 0
      : Math.round((ordersCount / months_between) * 100) / 100

    const daysSinceLastOrder = lastOrderAt 
      ? Math.floor((Date.now() - new Date(lastOrderAt).getTime()) / (1000 * 60 * 60 * 24))
      : 0

    // –ü–æ–ª—É—á–∞–µ–º –º–∞–∫—Å–∏–º—É–º—ã —Å—Ä–µ–¥–∏ –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    const { data: allUsers, error: allUsersError } = await supabase
      .from('users')
      .select('id')
      .neq('role', 'admin')

    if (allUsersError) {
      userCalculation.value = null
      return
    }

    const allStats = []
    for (const u of allUsers) {
      const { data: userCartRows, error: userCartErr } = await supabase
        .from('cart')
        .select('id, created_at, count, price, status')
        .eq('userId', u.id)
        .eq('status', '–û—Ñ–æ—Ä–º–ª–µ–Ω')
        .order('created_at', { ascending: true })

      if (userCartErr) continue

      const userPaidItems = Array.isArray(userCartRows) ? userCartRows : []
      
      const userOrderGroups = new Map()
      userPaidItems.forEach(item => {
        const t = new Date(item.created_at)
        const key = new Date(t.getFullYear(), t.getMonth(), t.getDate(), t.getHours(), t.getMinutes()).getTime()
        if (!userOrderGroups.has(key)) userOrderGroups.set(key, [])
        userOrderGroups.get(key).push(item)
      })

      const userOrders = Array.from(userOrderGroups.values())
      const userTotalSpent = userPaidItems.reduce((acc, r) => acc + Number(r.price || 0) * Number(r.count || 0), 0)
      const userFirstOrderAt = userOrders.length ? userOrders[0][0].created_at : null
      const userLastOrderAt = userOrders.length ? userOrders[userOrders.length - 1][0].created_at : null

      const userMonthsBetween = userFirstOrderAt ? monthsBetween(userFirstOrderAt, new Date()) : 1
      const userAvgPurchasesPerMonth = userOrders.length === 0 || !userFirstOrderAt
        ? 0
        : Math.round((userOrders.length / userMonthsBetween) * 100) / 100

      const userDaysSinceLastOrder = userLastOrderAt 
        ? Math.floor((Date.now() - new Date(userLastOrderAt).getTime()) / (1000 * 60 * 60 * 24))
        : 0

      allStats.push({
        totalSpent: userTotalSpent,
        avgPurchasesPerMonth: userAvgPurchasesPerMonth,
        daysSinceLastOrder: userDaysSinceLastOrder
      })
    }

    // –ú–∞–∫—Å–∏–º—É–º—ã (—Ç–æ–ª—å–∫–æ —Å—Ä–µ–¥–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å –∑–∞–∫–∞–∑–∞–º–∏)
    const maxTotalSpent = Math.max(1, ...allStats.map(s => s.totalSpent), totalSpent)
    const maxAvgPurchasesPerMonth = Math.max(1, ...allStats.map(s => s.avgPurchasesPerMonth), avgPurchasesPerMonth)
    const maxDaysSinceLastOrder = Math.max(1, ...allStats.filter(s => s.daysSinceLastOrder > 0).map(s => s.daysSinceLastOrder))

    // –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è
    const P1_norm = maxTotalSpent > 0 ? totalSpent / maxTotalSpent : 0
    const P2_norm = maxAvgPurchasesPerMonth > 0 ? avgPurchasesPerMonth / maxAvgPurchasesPerMonth : 0
    // P3: –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –±–µ–∑ –∑–∞–∫–∞–∑–æ–≤ (daysSinceLastOrder = 0) —Å—Ç–∞–≤–∏–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –±–∞–ª–ª (1.0)
    // –¥–ª—è –æ—Å—Ç–∞–ª—å–Ω—ã—Ö: 1 - (–¥–Ω–∏_—Å_–ø–æ—Å–ª–µ–¥–Ω–µ–π_–ø–æ–∫—É–ø–∫–∏ / –º–∞–∫—Å–∏–º—É–º_—Å—Ä–µ–¥–∏_–≤—Å–µ—Ö_—Å_–∑–∞–∫–∞–∑–∞–º–∏)
    const P3_norm = daysSinceLastOrder === 0 ? 1 : (maxDaysSinceLastOrder > 0 ? 1 - (daysSinceLastOrder / maxDaysSinceLastOrder) : 1)

    // –ò–ü–õ
    const w1 = 0.5, w2 = 0.3, w3 = 0.2
    const K = (w1 * P1_norm) + (w2 * P2_norm) + (w3 * P3_norm)

    // –£—Ä–æ–≤–µ–Ω—å
    let discountPercent = 5
    let clientLevel = '–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π'
    if (K >= 0.6) { discountPercent = 15; clientLevel = '–ó–æ–ª–æ—Ç–æ–π' }
    else if (K >= 0.3) { discountPercent = 10; clientLevel = '–°–µ—Ä–µ–±—Ä—è–Ω—ã–π' }

    userCalculation.value = {
      user_id: checkUserId.value,
      name: `${user.surname} ${user.name} ${user.patronymic}`.trim(),
      orders_count: ordersCount,
      total_spent: totalSpent,
      months_between: months_between,
      avg_purchases_per_month: avgPurchasesPerMonth,
      days_since_last_order: daysSinceLastOrder,
      max_total_spent: maxTotalSpent,
      max_avg_per_month: maxAvgPurchasesPerMonth,
      max_days_since_last: maxDaysSinceLastOrder,
      p1_norm: Math.round(P1_norm * 100) / 100,
      p2_norm: Math.round(P2_norm * 100) / 100,
      p3_norm: Math.round(P3_norm * 100) / 100,
      k: Math.round(K * 1000) / 1000,
      client_level: clientLevel,
      discount_percent: discountPercent
    }

  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ —Ä–∞—Å—á—ë—Ç–∞:', error)
    userCalculation.value = null
  } finally {
    isLoadingCalculation.value = false
  }
}
</script>